image:
  name: atlassian/pipelines-awscli
definitions:
  caches:
    nodecustom: ./node_modules
    yarn: /usr/local/share/.cache/yarn
  steps:
    - step: &Test-step
        image: node:lts
        name: 'Testing...'
        caches:
          - nodecustom
          - yarn
        script:
            - yarn install --frozen-lockfile
            - yarn test
    - step: &Lint-step
        image: node:lts
        name: 'Linting...'
        caches:
          - nodecustom
          - yarn
        script:
            - yarn install --frozen-lockfile
            - yarn lint
    - step: &build-and-push-api
        name: build and push docker image
        caches:
          - docker
        services:
          - docker
        script:
          - export BUILD_ID=$BITBUCKET_BRANCH_$BITBUCKET_COMMIT_$BITBUCKET_BUILD_NUMBER
          - eval $(aws ecr get-login --region ${AWS_DEFAULT_REGION} --no-include-email)
          - docker build -f ./services/api/Dockerfile -t ${AWS_REGISTRY_URL}:api-$BUILD_ID .
          - docker push ${AWS_REGISTRY_URL}:api-$BUILD_ID
          - docker tag ${AWS_REGISTRY_URL}:api-$BUILD_ID ${AWS_REGISTRY_URL}:api-$BITBUCKET_BRANCH-latest
          - docker push ${AWS_REGISTRY_URL}:api-$BITBUCKET_BRANCH-latest
pipelines:
  branches:
    develop:
      - parallel:
        - step: *Test-step
        - step: *Lint-step
      - step: *build-and-push-api
    master:
      - step: *build-and-push-api

